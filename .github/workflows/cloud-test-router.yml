name: Test Router Services with Cloud SQL

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  test-router:
    # 1. REQUIRED: Set permissions to get the GitHub OIDC token
    permissions:
      contents: 'read'
      id-token: 'write' # Grants permission to fetch the OIDC token for WIF

    runs-on: ubuntu-latest

    # Global environment variables for the job
    env:
      # Application path setup
      PYTHONPATH: ${{ github.workspace }}/backend:${{ github.workspace }}/backend/router:${{ github.workspace }}/backend/embeddings:${{ github.workspace }}/backend/database
      
      # *** WIF & Cloud SQL IAM ENV VARS ***
      SERVICE_ACCOUNT_EMAIL: ${{ secrets.GCP_SERVICE_ACCOUNT }}
      INSTANCE_CONNECTION_NAME: ${{ secrets.INSTANCE_CONNECTION_NAME }}
      
      # Construct the DATABASE_URL for IAM Auth: user is the SA email, password is empty, host is 127.0.0.1 (proxy)
      DATABASE_URL: postgresql://${{ secrets.GCP_SERVICE_ACCOUNT }}:@127.0.0.1:5432/${{ secrets.DB_NAME }}
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('backend/**/pyproject.toml', 'backend/**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-


    
    - name: Install Python dependencies
      working-directory: ./backend
      run: |
        python -m pip install --upgrade pip
        pip install fastapi httpx uvicorn sse-starlette python-multipart python-dotenv
        pip install pytest pytest-asyncio sentence_transformers sqlalchemy alembic python-dateutil
        
        # Install local packages as editable
        pip install -e ./router
        pip install -e ./embeddings

    # 5. AUTHENTICATE TO GOOGLE CLOUD VIA WIF
    - name: 'Authenticate to Google Cloud'
      id: 'auth'
      uses: 'google-github-actions/auth@v2'
      with:
        workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
        service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
        # Credentials are now set as Application Default Credentials (ADC)
        
    # 6. START CLOUD SQL PROXY USING IAM AUTH
    - name: 'Start Cloud SQL Proxy'
      run: |
        wget https://storage.googleapis.com/cloud-sql-connectors/cloud-sql-proxy/v2.10.0/cloud-sql-proxy.linux.amd64 -O cloud-sql-proxy
        chmod +x cloud-sql-proxy
        # --auto-iam-authn uses the ADC established by the 'Authenticate' step
        ./cloud-sql-proxy --auto-iam-authn ${{ env.INSTANCE_CONNECTION_NAME }} &
        echo $! > cloud-sql-proxy.pid
        sleep 5 # Wait for the proxy to initialize
      
    - name: Create test environment file
      working-directory: ./backend
      run: |
        cat > .env << EOF
        RATING_INFERENCE_KEY=${{ secrets.RATING_INFERENCE_KEY }}
        INFERENCE_URL=https://inference.geist.im
        EMBEDDINGS_URL=https://embeddings.geist.im
        HARMONY_ENABLED=false
        LOG_LEVEL=INFO
        # Use the WIF-constructed DATABASE_URL from the env block
        DATABASE_URL=${{ env.DATABASE_URL }} 
        EOF

    - name: Start router service
      working-directory: ./backend/router
      run: |
        python main.py > router.log 2>&1 &
        echo $! > router.pid
        sleep 10
      env:
        RATING_INFERENCE_KEY: ${{ secrets.RATING_INFERENCE_KEY }}
        USE_REMOTE_INFERENCE: false
        INFERENCE_URL: https://inference.geist.im
        EMBEDDINGS_URL: https://embeddings.geist.im
        LOG_LEVEL: INFO
        # Note: App should read DATABASE_URL from .env file created above

    - name: Debug router log
      run: cat backend/router/router.log || true

    - name: Wait for router to be ready
      run: |
        timeout 60 bash -c 'until curl -f http://localhost:8000/health; do sleep 2; done'

    - name: Run streaming tests (test_conversation.py)
      working-directory: ./backend/router
      run: |
        echo "=== Starting streaming tests ==="
        python test_conversation.py
        echo "=== Streaming tests completed ==="
      # No need to explicitly pass DATABASE_URL here if the test also reads the .env file

    - name: Run health check tests
      working-directory: ./backend/router
      run: |
        python test_health_endpoint.py

    - name: Save router logs
      if: always()
      working-directory: ./backend/router
      run: |
        echo "=== Router Logs ==="
        cat router.log || echo "No router.log found"
        echo "=== End Router Logs ==="

    - name: Cleanup
      if: always()
      run: |
        # Cleanup router service
        if [ -f backend/router/router.pid ]; then
          kill $(cat backend/router/router.pid) 2>/dev/null || true
          rm -f backend/router/router.pid
        fi
        pkill -f "python main.py" || true
        
        # Cleanup Cloud SQL Proxy
        if [ -f cloud-sql-proxy.pid ]; then
          kill $(cat cloud-sql-proxy.pid) 2>/dev/null || true
          rm -f cloud-sql-proxy.pid
        fi