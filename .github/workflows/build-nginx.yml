name: Build Nginx Service

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
        description: 'Environment (development, staging, production)'
      version:
        required: true
        type: string
        description: 'Version number (semver)'

jobs:
  build_and_push:
    name: Build and Push Nginx Docker Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ› DEBUG - Print all environment and secret info
        run: |
          echo "ğŸ” =========================== DEBUG INFO ==========================="
          echo "ğŸ“… Timestamp: $(date)"
          echo "ğŸƒ Runner OS: ${{ runner.os }}"
          echo "ğŸƒ Runner Arch: ${{ runner.arch }}"
          echo "ğŸ“‚ Workspace: ${{ github.workspace }}"
          echo "ğŸ”§ GitHub Actor: ${{ github.actor }}"
          echo "ğŸŒ¿ GitHub Ref: ${{ github.ref }}"
          echo "ğŸ“¦ Repository: ${{ github.repository }}"
          echo ""
          echo "ğŸ“‹ =========================== INPUTS ==========================="
          echo "ğŸŒ Environment: '${{ inputs.environment }}'"
          echo "ğŸ·ï¸  Version: '${{ inputs.version }}'"
          echo ""
          echo "ğŸ” =========================== SECRETS DEBUG ==========================="
          echo "ğŸ‘¤ DOCKER_USERNAME exists: ${{ secrets.DOCKER_USERNAME != '' }}"
          echo "ğŸ”‘ DOCKER_PASSWORD exists: ${{ secrets.DOCKER_PASSWORD != '' }}"
          echo "ğŸ‘¤ DOCKER_USERNAME length: ${#DOCKER_USERNAME}"
          echo "ğŸ”‘ DOCKER_PASSWORD length: ${#DOCKER_PASSWORD}"
          echo "ğŸ‘¤ DOCKER_USERNAME first 3 chars: ${DOCKER_USERNAME:0:3}***"
          echo "ğŸ”‘ DOCKER_PASSWORD first 3 chars: ${DOCKER_PASSWORD:0:3}***"
          echo ""
          echo "ğŸ” =========================== SECRET VALUES CHECK ==========================="
          if [ -z "$DOCKER_USERNAME" ]; then
            echo "âŒ DOCKER_USERNAME is EMPTY or NULL"
          else
            echo "âœ… DOCKER_USERNAME has value"
          fi
          if [ -z "$DOCKER_PASSWORD" ]; then
            echo "âŒ DOCKER_PASSWORD is EMPTY or NULL"
          else
            echo "âœ… DOCKER_PASSWORD has value"
          fi
          echo ""
          echo "ğŸ³ =========================== DOCKER INFO ==========================="
          docker --version
          docker info --format '{{json .}}' | jq -r '.ServerVersion // "No server info"'
          echo ""
          echo "ğŸ” =========================== ENVIRONMENT VARIABLES ==========================="
          env | grep -E "(DOCKER|GITHUB)" | sort
          echo ""
          echo "ğŸ” =========================== END DEBUG INFO ==========================="
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKER_USERNAME }}/nginx-server
          tags: |
            type=raw,value=${{ inputs.version }}
            type=raw,value=${{ inputs.environment }}-${{ inputs.version }}
            type=raw,value=${{ inputs.environment }}-latest

      - name: Build and push Docker image
        id: build_and_push
        uses: docker/build-push-action@v5
        with:
          context: ./backend/nginx
          file: ./backend/nginx/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Image digest
        run: echo ${{ steps.build_and_push.outputs.digest }}
